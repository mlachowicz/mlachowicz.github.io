---
layout: post
title: "Kioptrix: Level 1"
excerpt: "Script kiddies walkthrough for beginner's penetration testing VM."
image: 
tags: 
  - cybersecurity
  - hacking
  - kioptrix
---

Kioptrix is a group of virtual machines that have been made vulnerable on purpose for people to practice and learn penetration testing techniques. Penetration testing is a way to identify and exploit weaknesses in different operating systems and web applications to enhance cybersecurity skills.

The Kioptrix virtual machines simulate real-life situations and are designed to have weaknesses that can be exploited in different ways such as buffer overflows, SQL injection, and cross-site scripting. By practicing on Kioptrix, you can get hands-on experience in detecting and exploiting these vulnerabilities and learn how to protect systems and applications against potential attacks.

It's important to note that Kioptrix is a legal and ethical way of practicing penetration testing because it's solely meant for educational purposes and shouldn't be used for malicious activities.

First of the Kioptrix series can be found at <a href="https://www.vulnhub.com/" target="_blank">VulnHub</a>.

<a href="https://www.vulnhub.com/entry/kioptrix-level-1-1,22/" target="_blank">https://vulnhub.com/entry/kioptrix-level-1-1,22/</a>

## Preparation

Besides Kioptrix's image file, obviously, you need software to run it. Paid <a href="https://www.vmware.com/products/fusion.html" target="_blank">VMware Fusion</a> or free <a href="https://www.virtualbox.org/wiki/Downloads" target="_blank">Virtual Box</a> will be the best way to go. I don't want to focus here on how to run the VM itself, as this is really very intuitive and there are plenty of tutorials on how to do that. You will need also a Linux distribution - the best choice will be <a href="https://www.kali.org/get-kali/#kali-platforms" target="_blank">Kali Linux</a> or <a href="https://parrotsec.org/download/" target="_blank">Parrot OS</a>, as both of those distros are penetration testing focused and have all tools that you need.

If you're setting up your offensive system and Kioptrix on the same machine, the best solution is to set both Network Adapters as Bridged. Bridged networking connects your virtual machine to a network using the network adapter on your host system. If your host system is on a network, this is the easiest way to give your virtual machine access to that network.

Bridged networking also sets up your virtual machine as a unique identity on the network, separate from and unrelated to your host system. Your virtual machine becomes a full participant in the network, with access to other machines on the network, and other machines on the network can contact it as if it were a physical computer on the network.

After setting everything up, you have to just run the Kioptrix machine. You don't have to log in (and you cannot, as you don't have a password yet), just leave it on in the background and use your default preferred Linux distribution to start the game.

## Reconnaissance

So first we have to determine the IP address of our Kioptrix victim machine. To do that, we will open terminal and use:

```
sudo arp-scan -l
```

Sudo command allows a system administrator to delegate authority to give certain users the ability to run commands as root. ARP-scan is a tool that uses the ARP protocol to discover and fingerprint IP hosts on the local network. -l	attribute can generate list from interface address and netmask.

```
─# sudo arp-scan -l                                                                                                                                       
Interface: eth0, type: EN10MB, MAC: 00:0c:29:13:ef:aa, IPv4: 192.168.0.10
Starting arp-scan 1.10.0 with 256 hosts (https://github.com/royhills/arp-scan)
192.168.0.1   54:db:a2:26:77:f8	Fibrain
192.168.0.5   7c:d1:c3:97:b8:88	Apple, Inc.
192.168.0.8   78:f2:35:19:42:93	Sichuan AI-Link Technology Co., Ltd.
192.168.0.14  00:0c:29:37:3b:69	VMware, Inc.
192.168.0.4   40:24:b2:b0:16:9c	Sichuan AI-Link Technology Co., Ltd.

5 packets received by filter, 0 packets dropped by kernel
Ending arp-scan 1.10.0: 256 hosts scanned in 2.055 seconds (124.57 hosts/sec). 5 responded
```

In my case, I can see that the IP for vulnerable host run through VMware is 192.168.0.14. At this point, I can check and visit this IP address via browser to confirm there is an HTTP service running on port 80.

<a href="/images/2023-04-26_151456.png"><img src="/images/2023-04-26_151456.png"></a>

## Scanning

Additionally, the next tool we're going to use to gather even more intel is [Nikto](https://github.com/sullo/nikto){:target="_blank" rel="noopener"}. It's a web server scanner that checks a website for many possible security problems, such as dangerous files, misconfigured services, and vulnerable scripts.

```
nikto -h 192.168.0.14
```

However, it's important to note that Nikto isn't a subtle tool. It will make more than 2000 HTTP GET requests to the web server, which will generate a lot of entries in the server's log files. This activity is a great way to test any existing intrusion detection systems, like log monitoring for the web server. So, if there is a Nikto scan running, these security systems will be able to detect it.

```
└─$ nikto -h 192.168.0.14         
- Nikto v2.5.0
---------------------------------------------------------------------------
+ Target IP:          192.168.0.14
+ Target Hostname:    192.168.0.14
+ Target Port:        80
+ Start Time:         2023-04-26 12:09:02 (GMT-4)
---------------------------------------------------------------------------
+ Server: Apache/1.3.20 (Unix)  (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b
+ /: Server may leak inodes via ETags, header found with file /, inode: 34821, size: 2890, mtime: Wed Sep  5 23:12:46 2001. See: http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2003-1418
+ /: The anti-clickjacking X-Frame-Options header is not present. See: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options
+ /: The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type. See: https://www.netsparker.com/web-vulnerability-scanner/vulnerabilities/missing-content-type-header/
+ /: Apache is vulnerable to XSS via the Expect header. See: http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2006-3918
+ OpenSSL/0.9.6b appears to be outdated (current is at least 3.0.7). OpenSSL 1.1.1s is current for the 1.x branch and will be supported until Nov 11 2023.
+ mod_ssl/2.8.4 appears to be outdated (current is at least 2.9.6) (may depend on server version).
+ Apache/1.3.20 appears to be outdated (current is at least Apache/2.4.54). Apache 2.2.34 is the EOL for the 2.x branch.
+ Apache/1.3.20 - Apache 1.x up 1.2.34 are vulnerable to a remote DoS and possible code execution.
+ Apache/1.3.20 - Apache 1.3 below 1.3.27 are vulnerable to a local buffer overflow which allows attackers to kill any process on the system.
+ Apache/1.3.20 - Apache 1.3 below 1.3.29 are vulnerable to overflows in mod_rewrite and mod_cgi.
+ mod_ssl/2.8.4 - mod_ssl 2.8.7 and lower are vulnerable to a remote buffer overflow which may allow a remote shell.
+ OPTIONS: Allowed HTTP Methods: GET, HEAD, OPTIONS, TRACE .
+ /: HTTP TRACE method is active which suggests the host is vulnerable to XST. See: https://owasp.org/www-community/attacks/Cross_Site_Tracing
+ ///etc/hosts: The server install allows reading of any system file by adding an extra '/' to the URL.
+ /usage/: Webalizer may be installed. Versions lower than 2.01-09 vulnerable to Cross Site Scripting (XSS). See: http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2001-0835
+ /manual/: Directory indexing found.
+ /manual/: Web server manual found.
+ /icons/: Directory indexing found.
+ /icons/README: Apache default file found. See: https://www.vntweb.co.uk/apache-restricting-access-to-iconsreadme/
+ /test.php: This might be interesting.
+ /wp-content/themes/twentyeleven/images/headers/server.php?filesrc=/etc/hosts: A PHP backdoor file manager was found.
+ /wordpress/wp-content/themes/twentyeleven/images/headers/server.php?filesrc=/etc/hosts: A PHP backdoor file manager was found.
+ /wp-includes/Requests/Utility/content-post.php?filesrc=/etc/hosts: A PHP backdoor file manager was found.
+ /wordpress/wp-includes/Requests/Utility/content-post.php?filesrc=/etc/hosts: A PHP backdoor file manager was found.
+ /wp-includes/js/tinymce/themes/modern/Meuhy.php?filesrc=/etc/hosts: A PHP backdoor file manager was found.
+ /wordpress/wp-includes/js/tinymce/themes/modern/Meuhy.php?filesrc=/etc/hosts: A PHP backdoor file manager was found.
+ /assets/mobirise/css/meta.php?filesrc=: A PHP backdoor file manager was found.
+ /login.cgi?cli=aa%20aa%27cat%20/etc/hosts: Some D-Link router remote command execution.
+ /shell?cat+/etc/hosts: A backdoor was identified.
+ /#wp-config.php#: #wp-config.php# file found. This file contains the credentials.
+ 8908 requests: 0 error(s) and 30 item(s) reported on remote host
+ End Time:           2023-04-26 12:09:26 (GMT-4) (24 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
```

The tool showed us a lot of potential security flaws on port 80, however, after close checking, we can determine that many of them are false positives and simply don't exist on this host. There are some free or paid alternatives for Nikto, however, most of them have disadvantages, and the best ones, like Nessus, are licensed and quite expensive.

Although vulnerabilities related to Apache servers can be interesting, I want to learn more about this particular host. I'm using [Nmap](https://nmap.org/book/man.html){:target="_blank" rel="noopener"} (“Network Mapper”) to scan the host and determine which other ports are open and what network services are running on the machine. 

```
sudo nmap -sSV -O 192.168.0.14
```
There are a couple of interesting things here. -sS is a TCP SYN stealth scan that can be performed quickly, scanning thousands of ports per second on a fast network not hampered by intrusive firewalls. SYN scan is relatively unobtrusive and stealthy since it never completes TCP connections. With -sV and -O attributes we can try to detect the service version and host operating system. If this would be a real server with Intrusion Detection System, I would probably resign with -sV and set -T1 to be less suspicious for the host's IDS.  

```
└─$ sudo nmap -sSV -O 192.168.0.14                                                                                                                      
Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-26 09:56 EDT
Nmap scan report for 192.168.0.14
Host is up (0.00064s latency).
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 2.9p2 (protocol 1.99)
80/tcp   open  http        Apache httpd 1.3.20 ((Unix)  (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b)
111/tcp  open  rpcbind     2 (RPC #100000)
139/tcp  open  netbios-ssn Samba smbd (workgroup: MYGROUP)
443/tcp  open  ssl/https   Apache/1.3.20 (Unix)  (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b
1024/tcp open  status      1 (RPC #100024)
MAC Address: 00:0C:29:37:3B:69 (VMware)
Device type: general purpose
Running: Linux 2.4.X
OS CPE: cpe:/o:linux:linux_kernel:2.4
OS details: Linux 2.4.9 - 2.4.18 (likely embedded)
Network Distance: 1 hop

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 13.33 seconds
```

Our scan revealed that we have some open ports and interested outdated services, which could be used as points of entry for a potential attack. This information is a good place to start... Now we know that besides port 80, we have open also 22, 111, 139, 443, and 1024. As I already know from a cybersecurity [report by Tenable](https://www.tenable.com/blog/vulnerabilities-by-common-ports-dashboard){:target="_blank" rel="noopener"}, a company that makes a popular cybersecurity tool called Nessus, some of them can be more interesting than others.

<a href="/images/commonports.png"><img src="/images/commonports.png"></a>

According to their report, the protocols HTTP/80, HTTPS/443, and SMB/445 are the most vulnerable to serious cyber attacks. However, even though SSH has a high number of vulnerabilities too, only 3% of those can actually be exploited by attackers. So, for now, I am going to shift my focus towards Samba which uses port 139 on the Kioptrix host. As Samba can utilize port 139 for older versions or 445 for newer ones, this shows me again how outdated and vulnerable can be this service.

## Exploitation

Now it's time to use a jack-of-all-trade tool - [Metasploit](https://www.metasploit.com/){:target="_blank" rel="noopener"}. This is a penetration testing framework, which is used to find vulnerabilities and exploit them in various systems and applications. It provides a suite of tools and techniques for penetration testers and security researchers to test and evaluate the security of systems and applications. Metasploit allows users to create their own custom modules for testing specific vulnerabilities and can also be integrated with other security tools and platforms. Its ease of use, flexibility, and large user community make it a popular tool for security professionals and researchers.

You can run Metasploit framework with a command:

```
msfconsole
```

There are a lot of options and commands for this tool that can be found eg. on the [OffSec website](https://www.offsec.com/metasploit-unleashed/msfconsole-commands/){:target="_blank" rel="noopener"}. As for now, we will search for Samba...

```console
msf6 > search samba

Matching Modules
================

   #   Name                                                 Disclosure Date  Rank       Check  Description
   -   ----                                                 ---------------  ----       -----  -----------
   0   exploit/unix/webapp/citrix_access_gateway_exec       2010-12-21       excellent  Yes    Citrix Access Gateway Command Execution
   1   exploit/windows/license/calicclnt_getconfig          2005-03-02       average    No     Computer Associates License Client GETCONFIG Overflow
   2   exploit/unix/misc/distcc_exec                        2002-02-01       excellent  Yes    DistCC Daemon Command Execution
   3   exploit/windows/smb/group_policy_startup             2015-01-26       manual     No     Group Policy Script Execution From Shared Resource
   4   post/linux/gather/enum_configs                                        normal     No     Linux Gather Configurations
   5   auxiliary/scanner/rsync/modules_list                                  normal     No     List Rsync Modules
   6   exploit/windows/fileformat/ms14_060_sandworm         2014-10-14       excellent  No     MS14-060 Microsoft Windows OLE Package Manager Code Execution
   7   exploit/unix/http/quest_kace_systems_management_rce  2018-05-31       excellent  Yes    Quest KACE Systems Management Command Injection
   8   exploit/multi/samba/usermap_script                   2007-05-14       excellent  No     Samba "username map script" Command Execution
   9   exploit/multi/samba/nttrans                          2003-04-07       average    No     Samba 2.2.2 - 2.2.6 nttrans Buffer Overflow
   10  exploit/linux/samba/setinfopolicy_heap               2012-04-10       normal     Yes    Samba SetInformationPolicy AuditEventsInfo Heap Overflow
   11  auxiliary/admin/smb/samba_symlink_traversal                           normal     No     Samba Symlink Directory Traversal
   12  auxiliary/scanner/smb/smb_uninit_cred                                 normal     Yes    Samba _netr_ServerPasswordSet Uninitialized Credential State
   13  exploit/linux/samba/chain_reply                      2010-06-16       good       No     Samba chain_reply Memory Corruption (Linux x86)
   14  exploit/linux/samba/is_known_pipename                2017-03-24       excellent  Yes    Samba is_known_pipename() Arbitrary Module Load
   15  auxiliary/dos/samba/lsa_addprivs_heap                                 normal     No     Samba lsa_io_privilege_set Heap Overflow
   16  auxiliary/dos/samba/lsa_transnames_heap                               normal     No     Samba lsa_io_trans_names Heap Overflow
   17  exploit/linux/samba/lsa_transnames_heap              2007-05-14       good       Yes    Samba lsa_io_trans_names Heap Overflow
   18  exploit/osx/samba/lsa_transnames_heap                2007-05-14       average    No     Samba lsa_io_trans_names Heap Overflow
   19  exploit/solaris/samba/lsa_transnames_heap            2007-05-14       average    No     Samba lsa_io_trans_names Heap Overflow
   20  auxiliary/dos/samba/read_nttrans_ea_list                              normal     No     Samba read_nttrans_ea_list Integer Overflow
   21  exploit/freebsd/samba/trans2open                     2003-04-07       great      No     Samba trans2open Overflow (*BSD x86)
   22  exploit/linux/samba/trans2open                       2003-04-07       great      No     Samba trans2open Overflow (Linux x86)
   23  exploit/osx/samba/trans2open                         2003-04-07       great      No     Samba trans2open Overflow (Mac OS X PPC)
   24  exploit/solaris/samba/trans2open                     2003-04-07       great      No     Samba trans2open Overflow (Solaris SPARC)
   25  exploit/windows/http/sambar6_search_results          2003-06-21       normal     Yes    Sambar 6 Search Results Buffer Overflow

Interact with a module by name or index. For example info 25, use 25 or use exploit/windows/http/sambar6_search_results
```

To be continued soon...
